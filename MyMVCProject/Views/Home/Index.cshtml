@{
    ViewData["Title"] = "Discover Your Style ✨";
}

<link rel="stylesheet" href="~/css/Index.css" asp-append-version="true" />
<base href="~/Images/~" />
<!-- 🎀 Offer Carousel -->
<!-- 💝 Slim Offer Carousel -->
<div id="offerCarousel" class="carousel slide mb-4" data-bs-ride="carousel" data-bs-interval="2500">
    <div class="carousel-inner">
        <div class="carousel-item active">
            <div class="offer-strip text-center">
                💖 Flat 50% Off on Winter Collection! | Coats, Sweaters & More!
            </div>
        </div>
        <div class="carousel-item">
            <div class="offer-strip text-center">
                🎁 Buy 2 Get 1 Free on All Accessories! | Elevate Your Style Today!
            </div>
        </div>
        <div class="carousel-item">
            <div class="offer-strip text-center">
                🔥 New Arrivals! Dresses That Define You — Shop Now!
            </div>
        </div>
    </div>
</div>

<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap text-center position-relative heading-bar">
        <!-- Left: Filter Dropdown -->
        <div class="dropdown filter-dropdown">
            <button class="btn btn-outline-dark dropdown-toggle shadow-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-funnel"></i> Filter
            </button>
            <ul class="dropdown-menu modern-dropdown">
                <li><h6 class="dropdown-header text-muted">Categories</h6></li>
                <li><a class="dropdown-item" href="#">Dresses</a></li>
                <li><a class="dropdown-item" href="#">Tops</a></li>
                <li><a class="dropdown-item" href="#">Jeans</a></li>
                <li><a class="dropdown-item" href="#">Winter Wear</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger fw-semibold" href="#">Clear Filters</a></li>
            </ul>
        </div>

        <!-- Center: Title -->
        <h2 class="fancy-heading mb-0 flex-grow-1 text-center">
            Discover Your Style ✨
        </h2>

        <!-- Right: Sort Dropdown -->
        <div class="dropdown sort-dropdown">
            <button class="btn btn-outline-dark dropdown-toggle shadow-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-sort-down"></i> Sort
            </button>
            <ul class="dropdown-menu dropdown-menu-end modern-dropdown">
                <li><h6 class="dropdown-header text-muted">Sort By</h6></li>
                <li><a class="dropdown-item" href="#">Price: Low to High</a></li>
                <li><a class="dropdown-item" href="#">Price: High to Low</a></li>
                <li><a class="dropdown-item" href="#">Rating</a></li>
                <li><a class="dropdown-item" href="#">Newest Arrivals</a></li>
            </ul>
        </div>
    </div>

    <section id="gallery" class="gallery-grid"></section>

    <div id="loading" class="text-center mt-4">
        <div class="spinner-border text-dark" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const gallery = document.getElementById('gallery');
        const loading = document.getElementById('loading');
        const searchForm = document.getElementById('searchForm');
        const searchInput = document.getElementById('searchInput');

        
        async function fetchProducts(query = "") {
            loading.style.display = "block";
            try {
                let url = "";

                // if user typed something → call search API
                if (query && query.trim() !== "") {
                    url = `/Home/SearchProducts?query=${encodeURIComponent(query)}`;
                }
                // else → load all products
                else {
                    url = `/api/product`;
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error("Failed to load products");

                const products = await response.json();
                renderProducts(products);
                await highlightWishlistItems(); // highlight wishlist hearts
            } catch (err) {
                console.error("Product fetch error:", err);
            } finally {
                loading.style.display = "none";
            }
        }


        // ✅ Render product cards
        function renderProducts(products) {
            gallery.innerHTML = '';

            if (!products || products.length === 0) {
                gallery.innerHTML = `<p class="text-center text-muted mt-3">No products found.</p>`;
                return;
            }

            products.forEach(item => {
                const fig = document.createElement('figure');
                fig.classList.add('item');
                fig.innerHTML = `
                    <img src="${item.imageUrl}" alt="${item.title}">
                    <figcaption>
                        <h5>${item.title}</h5>
                        <p>₹${item.price}</p>
                        <span>⭐ ${item.rating}</span>
                        <div class="hover-options">
                            <div class="sizes">
                                <button class="size">S</button>
                                <button class="size">M</button>
                                <button class="size">L</button>
                            </div>
                            <div class="actions">
                                <button class="wishlist-btn" data-id="${item.productId}">
                                    <i class="bi bi-heart"></i>
                                </button>
                                <button class="add-cart">Add to Cart</button>
                            </div>
                        </div>
                    </figcaption>`;
                gallery.appendChild(fig);
            });
        }

        // ✅ Highlight wishlist hearts
        async function highlightWishlistItems() {
            try {
                const response = await fetch('/Wishlist/GetUserWishlist');
                const result = await response.json();

                if (result.success && result.data?.length > 0) {
                    const wishlistIds = result.data.map(w => w.productId);
                    document.querySelectorAll('.wishlist-btn').forEach(btn => {
                        const pid = parseInt(btn.dataset.id);
                        if (wishlistIds.includes(pid)) {
                            const icon = btn.querySelector('i');
                            icon.classList.replace('bi-heart', 'bi-heart-fill');
                            icon.style.color = 'red';
                        }
                    });
                }
            } catch (err) {
                console.error("Highlight wishlist error:", err);
            }
        }

        // ✅ Update wishlist count badge
        async function updateWishlistCount() {
            const badge = document.getElementById('wishlist-count');
            try {
                const response = await fetch('/Wishlist/GetUserWishlist');
                const result = await response.json();

                if (result.success && result.data) {
                    const count = result.data.length;
                    if (count > 0) {
                        badge.style.display = 'inline-block';
                        badge.textContent = count;
                    } else {
                        badge.style.display = 'none';
                    }
                } else {
                    badge.style.display = 'none';
                }
            } catch (err) {
                console.error("Wishlist count fetch error:", err);
                badge.style.display = 'none';
            }
        }

        // ✅ Wishlist button toggle
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('.wishlist-btn');
            if (!btn) return;

            const icon = btn.querySelector('i');
            const productId = parseInt(btn.dataset.id);

            try {
                if (icon.classList.contains('bi-heart')) {
                    const addRes = await fetch('/Wishlist/Add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ProductId: productId })
                    });
                    const result = await addRes.json();

                    if (!result.success && result.message) {
                        alert(result.message);
                        window.location.href = '/Account/Login';
                        return;
                    }

                    icon.classList.replace('bi-heart', 'bi-heart-fill');
                    icon.style.color = 'red';
                } else {
                    const removeRes = await fetch('/Wishlist/Remove', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ProductId: productId })
                    });
                    const removeResult = await removeRes.json();

                    if (removeResult.success) {
                        icon.classList.replace('bi-heart-fill', 'bi-heart');
                        icon.style.color = '';
                    }
                }

                await updateWishlistCount();
            } catch (error) {
                console.error('Wishlist update error:', error);
            }
        });

        // ✅ Search form submit (without leaving page)
               // ✅ Prevent form from reloading page and call our JS function instead
        if (searchForm && searchInput) {
            searchForm.addEventListener('submit', async (e) => {
                e.preventDefault(); // stop normal page reload

                const query = searchInput.value.trim();

                // Update the URL so user sees ?query=term but no reload happens
                const newUrl = query ? `?query=${encodeURIComponent(query)}` : window.location.pathname;
                window.history.pushState({}, '', newUrl);

                await fetchProducts(query); // load search results dynamically
            });
        }


        // ✅ Initial load
                   document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('query') || "";
            console.log("Search query from URL:", query);
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.value = query;

            await fetchProducts(query); // this will now load filtered products
            await updateWishlistCount();
        });

                let selectedProductId = null;
        let fromWishlist = false;

        // Open modal when user clicks Add to Cart / Move to Cart
        document.addEventListener('click', (e) => {
            const addBtn = e.target.closest('.add-cart');
            const moveBtn = e.target.closest('.move-to-cart-btn');
            if (!addBtn && !moveBtn) return;

            selectedProductId = parseInt((addBtn || moveBtn).dataset.id);
            fromWishlist = !!moveBtn;

            const modal = new bootstrap.Modal(document.getElementById('sizeModal'));
            modal.show();
        });

        // Handle size selection
        document.querySelectorAll('.size-option').forEach(btn => {
            btn.addEventListener('click', async () => {
                const size = btn.dataset.size;

                try {
                    const response = await fetch('/Cart/Add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ProductId: selectedProductId, Size: size })
                    });
                    const result = await response.json();

                    if (result.success) {
                        alert('Added to cart 🛒');
                        if (fromWishlist) {
                            await fetch('/Wishlist/Remove', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ ProductId: selectedProductId })
                            });
                        }
                    } else {
                        alert(result.message || 'Failed to add item.');
                    }
                } catch (err) {
                    console.error("Add to cart error:", err);
                }

                const modal = bootstrap.Modal.getInstance(document.getElementById('sizeModal'));
                modal.hide();
            });
        });

    </script>
  
<script>
    let selectedProductId = null;
    let selectedSize = null;

    // 🎯 When user clicks "Add to Cart" button
    document.addEventListener('click', function (e) {
        const addBtn = e.target.closest('.add-cart');
        if (!addBtn) return;

        // Store the product ID from button data
        selectedProductId = parseInt(addBtn.closest('figure').querySelector('.wishlist-btn').dataset.id);

        // Show size selection modal
        const sizeModal = new bootstrap.Modal(document.getElementById('sizeModal'));
        sizeModal.show();
    });

    // 🎯 When user selects a size from modal
    document.querySelectorAll('.size-option').forEach(btn => {
        btn.addEventListener('click', async function () {
            selectedSize = this.getAttribute('data-size');

            if (!selectedProductId || !selectedSize) {
                alert("Something went wrong. Please try again.");
                return;
            }

            try {
                const response = await fetch('/Cart/AddToCart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: selectedProductId,
                        size: selectedSize,
                        quantity: 1
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert("Item added to cart!");
                    updateCartCount(); // optional: updates badge count
                } else {
                    alert(result.message || "Failed to add item to cart.");
                }

                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('sizeModal'));
                modal.hide();

            } catch (err) {
                console.error("Add to cart error:", err);
            }
        });
    });

    // 🧮 Update cart count badge in navbar
    async function updateCartCount() {
        const badge = document.getElementById('cart-count');
        try {
            const response = await fetch('/Cart/GetUserCart');
            const result = await response.json();

            if (result.success && result.data) {
                const count = result.data.length;
                if (count > 0) {
                    badge.style.display = 'inline-block';
                    badge.textContent = count;
                } else {
                    badge.style.display = 'none';
                }
            }
        } catch (err) {
            console.error("Cart count update error:", err);
        }
    }

    document.addEventListener('DOMContentLoaded', updateCartCount);
</script>


}

