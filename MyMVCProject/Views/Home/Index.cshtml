@{
    ViewData["Title"] = "Discover Your Style ✨";
}

<link rel="stylesheet" href="~/css/Index.css" asp-append-version="true" />
<base href="~/Images/~" />
<!-- 🎀 Offer Carousel -->
<!-- 💝 Slim Offer Carousel -->
<div id="offerCarousel" class="carousel slide mb-4" data-bs-ride="carousel" data-bs-interval="2500">
    <div class="carousel-inner">
        <div class="carousel-item active">
            <div class="offer-strip text-center">
                💖 Flat 50% Off on Winter Collection! | Coats, Sweaters & More!
            </div>
        </div>
        <div class="carousel-item">
            <div class="offer-strip text-center">
                🎁 Buy 2 Get 1 Free on All Accessories! | Elevate Your Style Today!
            </div>
        </div>
        <div class="carousel-item">
            <div class="offer-strip text-center">
                🔥 New Arrivals! Dresses That Define You — Shop Now!
            </div>
        </div>
    </div>
</div>

<div class="container my-5">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap text-center position-relative heading-bar">
        <!-- Left: Filter Dropdown -->
        <div class="dropdown filter-dropdown">
            <button class="btn btn-outline-dark dropdown-toggle shadow-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-funnel"></i> Filter
            </button>
            <ul class="dropdown-menu modern-dropdown" id="filterMenu">
                <li><h6 class="dropdown-header text-muted">Categories</h6></li>
                <li><a class="dropdown-item filter-option" data-category="Dresses">Dresses</a></li>
                <li><a class="dropdown-item filter-option" data-category="Tops">Tops</a></li>
                <li><a class="dropdown-item filter-option" data-category="Jeans">Jeans</a></li>
                <li><a class="dropdown-item filter-option" data-category="Winter Wear">Winter Wear</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger fw-semibold clear-filters" href="#">Clear Filters</a></li>
            </ul>
        </div> 

        <!-- Center: Title -->
        <h2 class="fancy-heading mb-0 flex-grow-1 text-center">
            Discover Your Style ✨
        </h2>

        <!-- Right: Sort Dropdown -->
        <div class="dropdown sort-dropdown">
            <button class="btn btn-outline-dark dropdown-toggle shadow-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-sort-down"></i> Sort
            </button>
            <ul class="dropdown-menu dropdown-menu-end modern-dropdown" id="sortMenu">
                <li><h6 class="dropdown-header text-muted">Sort By</h6></li>
                <li><a class="dropdown-item sort-option" data-sort="low">Price: Low to High</a></li>
                <li><a class="dropdown-item sort-option" data-sort="high">Price: High to Low</a></li>
                <li><a class="dropdown-item sort-option" data-sort="rating">Rating</a></li>
                <li><a class="dropdown-item sort-option" data-sort="newest">Newest Arrivals</a></li>
            </ul>
        </div>
    </div>

    <section id="gallery" class="gallery-grid"></section>

    <div id="loading" class="text-center mt-4">
        <div class="spinner-border text-dark" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const gallery = document.getElementById('gallery');
        const loading = document.getElementById('loading');
        const searchForm = document.getElementById('searchForm');
        const searchInput = document.getElementById('searchInput');

        let selectedCategory = "";
        let selectedSort = "";
        let allProducts = []; // ✅ Keep all fetched products in memory

        // ✅ Fetch all products (and cache them once)
        async function fetchProducts(query = "") {
            try {
                if (loading) loading.style.display = "block";

                let url = "";
                if (query && query.trim() !== "") {
                    url = `/Home/SearchProducts?query=${encodeURIComponent(query)}`;
                } else {
                    url = `/api/product`;
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error("Failed to load products");

                allProducts = await response.json();
                console.log("✅ All products fetched:", allProducts);

                applyFiltersAndRender(); // ✅ Always apply filters and sorting before render

            } catch (err) {
                console.error("❌ Product fetch error:", err);
                gallery.innerHTML = `<p class='text-danger text-center mt-4'>Failed to load products.</p>`;
            } finally {
                if (loading) loading.style.display = "none";
            }
        }

        // ✅ Apply filtering + sorting + render in one place
        function applyFiltersAndRender() {
            let filtered = [...allProducts];

            // --- Apply Category Filter ---
            if (selectedCategory) {
                filtered = filtered.filter(p =>
                    p.category?.toLowerCase() === selectedCategory.toLowerCase()
                );
            }

            // --- Apply Sorting ---
            if (selectedSort === "low") {
                filtered.sort((a, b) => a.price - b.price);
            } else if (selectedSort === "high") {
                filtered.sort((a, b) => b.price - a.price);
            } else if (selectedSort === "rating") {
                filtered.sort((a, b) => (b.rating || 0) - (a.rating || 0));
            } else if (selectedSort === "newest") {
                filtered.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
            }

            console.log("🎯 After filter/sort:", filtered);
            renderProducts(filtered);
            highlightWishlistItems();
        }

        // ✅ Render product cards
        function renderProducts(products) {
            gallery.innerHTML = '';

            if (!products || products.length === 0) {
                gallery.innerHTML = `<p class="text-center text-muted mt-3">No products found.</p>`;
                return;
            }

            products.forEach(item => {
                const fig = document.createElement('figure');
                fig.classList.add('item');
                fig.innerHTML = `
                    <img src="${item.imageUrl}" alt="${item.title}">
                    <figcaption>
                        <h5>${item.title}</h5>
                        <p>₹${item.price}</p>
                        <span>⭐ ${item.rating || "N/A"}</span>
                        <div class="hover-options">
                            <div class="sizes">
                                <button class="size" data-size="S">S</button>
                                <button class="size" data-size="M">M</button>
                                <button class="size" data-size="L">L</button>
                            </div>

                            <div class="actions">
                                <button class="wishlist-btn" data-id="${item.productId}">
                                    <i class="bi bi-heart"></i>
                                </button>
                                <button class="add-cart" data-id="${item.productId}">Add to Cart</button>
                            </div>
                        </div>
                    </figcaption>`;
                gallery.appendChild(fig);
            });
        }

        // ✅ Highlight wishlist hearts
        async function highlightWishlistItems() {
            try {
                const response = await fetch('/Wishlist/GetUserWishlist');
                const result = await response.json();

                if (result.success && result.data?.length > 0) {
                    const wishlistIds = result.data.map(w => w.productId);
                    document.querySelectorAll('.wishlist-btn').forEach(btn => {
                        const pid = parseInt(btn.dataset.id);
                        if (wishlistIds.includes(pid)) {
                            const icon = btn.querySelector('i');
                            icon.classList.replace('bi-heart', 'bi-heart-fill');
                            icon.style.color = 'red';
                        }
                    });
                }
            } catch (err) {
                console.error("Highlight wishlist error:", err);
            }
        }

        // ✅ Wishlist count updater (unchanged)
        async function updateWishlistCount() {
            const badge = document.getElementById('wishlist-count');
            try {
                const response = await fetch('/Wishlist/GetUserWishlist');
                const result = await response.json();
                const count = result.success && result.data ? result.data.length : 0;

                if (count > 0) {
                    badge.style.display = 'inline-block';
                    badge.textContent = count;
                } else {
                    badge.style.display = 'none';
                }
            } catch {
                badge.style.display = 'none';
            }
        }

        // ✅ Wishlist button toggle (unchanged)
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('.wishlist-btn');
            if (!btn) return;

            const icon = btn.querySelector('i');
            const productId = parseInt(btn.dataset.id);

            try {
                if (icon.classList.contains('bi-heart')) {
                    const addRes = await fetch('/Wishlist/Add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ProductId: productId })
                    });
                    const result = await addRes.json();
                    if (!result.success && result.message) {
                        alert(result.message);
                        window.location.href = '/Account/Login';
                        return;
                    }
                    icon.classList.replace('bi-heart', 'bi-heart-fill');
                    icon.style.color = 'red';
                } else {
                    const removeRes = await fetch('/Wishlist/Remove', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ProductId: productId })
                    });
                    const removeResult = await removeRes.json();
                    if (removeResult.success) {
                        icon.classList.replace('bi-heart-fill', 'bi-heart');
                        icon.style.color = '';
                    }
                }

                await updateWishlistCount();
            } catch (error) {
                console.error('Wishlist update error:', error);
            }
        });

        // ✅ Search without reload
        if (searchForm && searchInput) {
            searchForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const query = searchInput.value.trim();
                const newUrl = query ? `?query=${encodeURIComponent(query)}` : window.location.pathname;
                window.history.pushState({}, '', newUrl);
                await fetchProducts(query);
            });
        }

        // ✅ FILTER HANDLER
        document.addEventListener("click", (e) => {
            const filterOption = e.target.closest(".filter-option");
            const clearFilter = e.target.closest(".clear-filters");

            if (filterOption) {
                selectedCategory = filterOption.dataset.category;
                console.log("✅ Selected category:", selectedCategory);
                document.querySelectorAll(".filter-option").forEach(el => el.classList.remove("active"));
                filterOption.classList.add("active");
                applyFiltersAndRender(); // ✅ no refetch, just re-render
            }

            if (clearFilter) {
                selectedCategory = "";
                console.log("🧹 Filters cleared");
                document.querySelectorAll(".filter-option").forEach(el => el.classList.remove("active"));
                applyFiltersAndRender();
            }
        });

        // ✅ SORT HANDLER
        document.addEventListener("click", (e) => {
            const sortOption = e.target.closest(".sort-option");

            if (sortOption) {
                selectedSort = sortOption.dataset.sort;
                console.log("✅ Selected sort:", selectedSort);
                document.querySelectorAll(".sort-option").forEach(el => el.classList.remove("active"));
                sortOption.classList.add("active");
                applyFiltersAndRender();
            }
        });

        // ✅ Initial load
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('query') || "";
            if (searchInput) searchInput.value = query;
            await fetchProducts(query);
            await updateWishlistCount();
        });

                // Size selection highlight
           document.addEventListener("click", (e) => {
            const sizeBtn = e.target.closest(".size");
            if (!sizeBtn) return;

            const parent = sizeBtn.closest(".sizes");
            if (!parent) return;

            parent.querySelectorAll(".size").forEach(b => b.classList.remove("selected"));
            sizeBtn.classList.add("selected");
        });

        // Single, correct Add-to-Cart handler
        document.addEventListener('click', async (e) => {
            const addBtn = e.target.closest('.add-cart');
            if (!addBtn) return;

            // get product id from dataset
            const productId = parseInt(addBtn.dataset.id, 10);
            if (!productId || isNaN(productId)) {
                console.error("Add to cart: invalid product id", addBtn.dataset.id);
                alert("Unable to add item (invalid product).");
                return;
            }

            // find selected size in the same product card
            const figcaption = addBtn.closest('figcaption') || addBtn.closest('.item');
            if (!figcaption) {
                console.error("Add to cart: cannot find product card/figcaption");
                alert("Something went wrong. Try again.");
                return;
            }

            const sizeBlock = figcaption.querySelector('.sizes');
            const selectedSizeBtn = sizeBlock ? sizeBlock.querySelector('.size.selected') : null;

            if (!selectedSizeBtn) {
                alert("⚠️ Please select a size to proceed!");
                return;
            }

            const selectedSize = selectedSizeBtn.dataset.size || selectedSizeBtn.textContent.trim();

            // Prepare payload (match your AddCartRequest properties)
            const payload = {
                ProductId: productId,   // server binder is case-insensitive, but PascalCase is clearer
                Size: selectedSize,
                Quantity: 1
            };

            try {
                const response = await fetch('/Cart/AddToCart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    console.error("AddToCart failed HTTP:", response.status, await response.text());
                    alert("Unable to add to cart (network error).");
                    return;
                }

                const result = await response.json();

                if (result.success) {
                    // Redirect to cart route (NOT view file path)
                    window.location.href = "/Home/Cart";
                } else {
                    // server returned success: false
                    alert(result.message || "Unable to add item to cart");
                }

            } catch (error) {
                console.error("Cart error:", error);
                alert("Something went wrong!");
            }
        });


                
                </script>

  


}

