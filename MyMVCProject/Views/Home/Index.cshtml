@{
    ViewData["Title"] = "Discover Your Style ✨";
}

<link rel="stylesheet" href="~/css/Index.css" asp-append-version="true" />
<base href="~/Images/~" />

<div class="container my-5">
    <h2 class="text-center mb-4 fancy-heading">Discover Your Style ✨</h2>

    <section id="gallery" class="gallery-grid"></section>

    <div id="loading" class="text-center mt-4">
        <div class="spinner-border text-dark" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const gallery = document.getElementById('gallery');
        const loading = document.getElementById('loading');
        const searchForm = document.getElementById('searchForm');
        const searchInput = document.getElementById('searchInput');

        
        async function fetchProducts(query = "") {
            loading.style.display = "block";
            try {
                let url = "";

                // if user typed something → call search API
                if (query && query.trim() !== "") {
                    url = `/Home/SearchProducts?query=${encodeURIComponent(query)}`;
                }
                // else → load all products
                else {
                    url = `/api/product`;
                }

                const response = await fetch(url);
                if (!response.ok) throw new Error("Failed to load products");

                const products = await response.json();
                renderProducts(products);
                await highlightWishlistItems(); // highlight wishlist hearts
            } catch (err) {
                console.error("Product fetch error:", err);
            } finally {
                loading.style.display = "none";
            }
        }


        // ✅ Render product cards
        function renderProducts(products) {
            gallery.innerHTML = '';

            if (!products || products.length === 0) {
                gallery.innerHTML = `<p class="text-center text-muted mt-3">No products found.</p>`;
                return;
            }

            products.forEach(item => {
                const fig = document.createElement('figure');
                fig.classList.add('item');
                fig.innerHTML = `
                    <img src="${item.imageUrl}" alt="${item.title}">
                    <figcaption>
                        <h5>${item.title}</h5>
                        <p>₹${item.price}</p>
                        <span>⭐ ${item.rating}</span>
                        <div class="hover-options">
                            <div class="sizes">
                                <button class="size">S</button>
                                <button class="size">M</button>
                                <button class="size">L</button>
                            </div>
                            <div class="actions">
                                <button class="wishlist-btn" data-id="${item.productId}">
                                    <i class="bi bi-heart"></i>
                                </button>
                                <button class="add-cart">Add to Cart</button>
                            </div>
                        </div>
                    </figcaption>`;
                gallery.appendChild(fig);
            });
        }

        // ✅ Highlight wishlist hearts
        async function highlightWishlistItems() {
            try {
                const response = await fetch('/Wishlist/GetUserWishlist');
                const result = await response.json();

                if (result.success && result.data?.length > 0) {
                    const wishlistIds = result.data.map(w => w.productId);
                    document.querySelectorAll('.wishlist-btn').forEach(btn => {
                        const pid = parseInt(btn.dataset.id);
                        if (wishlistIds.includes(pid)) {
                            const icon = btn.querySelector('i');
                            icon.classList.replace('bi-heart', 'bi-heart-fill');
                            icon.style.color = 'red';
                        }
                    });
                }
            } catch (err) {
                console.error("Highlight wishlist error:", err);
            }
        }

        // ✅ Update wishlist count badge
        async function updateWishlistCount() {
            const badge = document.getElementById('wishlist-count');
            try {
                const response = await fetch('/Wishlist/GetUserWishlist');
                const result = await response.json();

                if (result.success && result.data) {
                    const count = result.data.length;
                    if (count > 0) {
                        badge.style.display = 'inline-block';
                        badge.textContent = count;
                    } else {
                        badge.style.display = 'none';
                    }
                } else {
                    badge.style.display = 'none';
                }
            } catch (err) {
                console.error("Wishlist count fetch error:", err);
                badge.style.display = 'none';
            }
        }

        // ✅ Wishlist button toggle
        document.addEventListener('click', async (e) => {
            const btn = e.target.closest('.wishlist-btn');
            if (!btn) return;

            const icon = btn.querySelector('i');
            const productId = parseInt(btn.dataset.id);

            try {
                if (icon.classList.contains('bi-heart')) {
                    const addRes = await fetch('/Wishlist/Add', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ProductId: productId })
                    });
                    const result = await addRes.json();

                    if (!result.success && result.message) {
                        alert(result.message);
                        window.location.href = '/Account/Login';
                        return;
                    }

                    icon.classList.replace('bi-heart', 'bi-heart-fill');
                    icon.style.color = 'red';
                } else {
                    const removeRes = await fetch('/Wishlist/Remove', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ProductId: productId })
                    });
                    const removeResult = await removeRes.json();

                    if (removeResult.success) {
                        icon.classList.replace('bi-heart-fill', 'bi-heart');
                        icon.style.color = '';
                    }
                }

                await updateWishlistCount();
            } catch (error) {
                console.error('Wishlist update error:', error);
            }
        });

        // ✅ Search form submit (without leaving page)
               // ✅ Prevent form from reloading page and call our JS function instead
        if (searchForm && searchInput) {
            searchForm.addEventListener('submit', async (e) => {
                e.preventDefault(); // stop normal page reload

                const query = searchInput.value.trim();

                // Update the URL so user sees ?query=term but no reload happens
                const newUrl = query ? `?query=${encodeURIComponent(query)}` : window.location.pathname;
                window.history.pushState({}, '', newUrl);

                await fetchProducts(query); // load search results dynamically
            });
        }


        // ✅ Initial load
                   document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('query') || "";
            console.log("Search query from URL:", query);
            const searchInput = document.getElementById('searchInput');
            if (searchInput) searchInput.value = query;

            await fetchProducts(query); // this will now load filtered products
            await updateWishlistCount();
        });
    </script>
}

